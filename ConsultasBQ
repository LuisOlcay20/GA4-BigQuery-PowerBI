/*Consultas para comenzar con Bigquery y GA4 */

-- Funnel Chart --
-- Esta consulta debe devolver un resumen de las sesiones y eventos de un sitio web, agrupados por día, fuente de tráfico, categoría de dispositivo y tipo de evento, a partir de todo el conjunto de eventos --
SELECT
    PARSE_DATE("%Y%m%d", event_date) as date,
    traffic_source.medium as medium,
    traffic_source.source as source,
    device.category as device,
    COUNT(DISTINCT (
        SELECT value.int_value
        FROM UNNEST(event_params)
        WHERE key = 'ga_session_id'
    )) AS sessions,
    COUNT(DISTINCT (
        SELECT value.int_value
        FROM UNNEST (event_params)
        WHERE event_name = 'form_start' AND key = 'ga_session_id'
    )) as form_start,
    COUNT(DISTINCT (
        SELECT value.int_value
        FROM UNNEST (event_params)
        WHERE event_name = 'form_submit' AND key = 'ga_session_id'
    )) as form_submit,
    COUNT(DISTINCT (
        SELECT value.int_value
        FROM UNNEST (event_params)
        WHERE event_name = 'confirmacion_aj' AND key = 'ga_session_id'
    )) as confirmacion_aj
FROM `analytics_358268804.events_*`
GROUP BY
    date,
    medium,
    source,
    device;

